<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†æˆæµ‹è¯• - æ¨¡å—é›†æˆéªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-suite {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-suite h2 {
            margin-top: 0;
            color: #555;
            font-size: 1.1em;
        }
        .test-case {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-case.pass {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .test-case.fail {
            background: #ffebee;
            color: #c62828;
        }
        .test-case .icon {
            font-size: 1.2em;
        }
        .summary {
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .summary.all-pass {
            background: #4CAF50;
        }
        .summary.has-fail {
            background: #f44336;
        }
        .error-detail {
            font-size: 0.85em;
            color: #c62828;
            margin-left: 30px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ”— é›†æˆæµ‹è¯• - æ¨¡å—é›†æˆéªŒè¯</h1>
    <p>éªŒè¯ Task 14.1: é›†æˆæ‰€æœ‰æ¨¡å— - Requirements: 1.3, 2.2, 3.3</p>
    <div id="testResults"></div>
    <div id="summary" class="summary"></div>

    <!-- åŠ è½½æ‰€æœ‰æ¨¡å— -->
    <script src="../js/data/DataManager.js"></script>
    <script src="../js/data/StorageManager.js"></script>
    <script src="../js/controllers/AppController.js"></script>
    <script src="../js/components/SubjectSelector.js"></script>
    <script src="../js/components/TextbookSelector.js"></script>
    <script src="../js/components/ChapterNavigator.js"></script>
    <script src="../js/components/PageRenderer.js"></script>
    <script src="../js/components/BookFlipper.js"></script>
    <script src="../js/components/AudioPlayer.js"></script>
    <script src="../js/components/VoiceSelector.js"></script>
    <script src="../js/components/ProgressTracker.js"></script>
    <script src="../js/components/TutorialGuide.js"></script>

    <script>
        // ç®€å•çš„æµ‹è¯•æ¡†æ¶
        const testResults = [];
        let currentSuite = '';

        function describe(name, fn) {
            currentSuite = name;
            fn();
        }

        function test(name, fn) {
            try {
                fn();
                testResults.push({ suite: currentSuite, name, pass: true });
            } catch (error) {
                testResults.push({ suite: currentSuite, name, pass: false, error: error.message });
            }
        }

        async function asyncTest(name, fn) {
            try {
                await fn();
                testResults.push({ suite: currentSuite, name, pass: true });
            } catch (error) {
                testResults.push({ suite: currentSuite, name, pass: false, error: error.message });
            }
        }

        function expect(actual) {
            return {
                toBe(expected) {
                    if (actual !== expected) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toEqual(expected) {
                    if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeNull() {
                    if (actual !== null) {
                        throw new Error(`Expected null, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeTruthy() {
                    if (!actual) {
                        throw new Error(`Expected truthy value, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeFalsy() {
                    if (actual) {
                        throw new Error(`Expected falsy value, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeDefined() {
                    if (actual === undefined) {
                        throw new Error('Expected value to be defined');
                    }
                },
                toBeInstanceOf(cls) {
                    if (!(actual instanceof cls)) {
                        throw new Error(`Expected instance of ${cls.name}`);
                    }
                },
                toHaveProperty(prop) {
                    if (!(prop in actual)) {
                        throw new Error(`Expected object to have property "${prop}"`);
                    }
                }
            };
        }

        // ========================================
        // é›†æˆæµ‹è¯•ç”¨ä¾‹
        // ========================================

        describe('æ¨¡å—åŠ è½½éªŒè¯', () => {
            test('AppController åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof AppController).toBe('function');
            });

            test('PageType æšä¸¾åº”è¯¥å·²å®šä¹‰', () => {
                expect(PageType).toBeDefined();
                expect(PageType.HOME).toBe('home');
                expect(PageType.SUBJECT).toBe('subject');
                expect(PageType.TEXTBOOK).toBe('textbook');
                expect(PageType.CHAPTER).toBe('chapter');
                expect(PageType.READING).toBe('reading');
                expect(PageType.SETTINGS).toBe('settings');
            });

            test('DataManager å•ä¾‹åº”è¯¥å·²åˆ›å»º', () => {
                expect(dataManager).toBeDefined();
                expect(typeof dataManager.getSubjects).toBe('function');
            });

            test('StorageManager å•ä¾‹åº”è¯¥å·²åˆ›å»º', () => {
                expect(storageManager).toBeDefined();
                expect(typeof storageManager.getUserPreferences).toBe('function');
            });

            test('AudioPlayer å•ä¾‹åº”è¯¥å·²åˆ›å»º', () => {
                expect(audioPlayer).toBeDefined();
                expect(typeof audioPlayer.play).toBe('function');
            });

            test('ProgressTracker å•ä¾‹åº”è¯¥å·²åˆ›å»º', () => {
                expect(progressTracker).toBeDefined();
                expect(typeof progressTracker.recordPageVisit).toBe('function');
            });

            test('SubjectSelector ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof SubjectSelector).toBe('function');
            });

            test('TextbookSelector ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof TextbookSelector).toBe('function');
            });

            test('ChapterNavigator ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof ChapterNavigator).toBe('function');
            });

            test('PageRenderer ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof PageRenderer).toBe('function');
            });

            test('BookFlipper ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof BookFlipper).toBe('function');
            });

            test('VoiceSelector ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof VoiceSelector).toBe('function');
            });

            test('TutorialGuide ç±»åº”è¯¥å·²åŠ è½½', () => {
                expect(typeof TutorialGuide).toBe('function');
            });
        });

        describe('AppController é›†æˆæµ‹è¯•', () => {
            test('AppController åº”è¯¥èƒ½æ­£ç¡®åˆå§‹åŒ–', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const state = controller.getCurrentState();
                expect(state.currentPage).toBe(PageType.HOME);
            });

            test('AppController åº”è¯¥æ”¯æŒå®Œæ•´çš„å¯¼èˆªæµç¨‹', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                // æ¨¡æ‹Ÿå®Œæ•´å¯¼èˆªæµç¨‹: é¦–é¡µ -> å­¦ç§‘ -> æ•™æ -> ç« èŠ‚ -> é˜…è¯»
                const subject = { id: 'english', name: 'è‹±è¯­' };
                const textbook = { id: 'pep-grade3', name: 'äººæ•™ç‰ˆä¸‰å¹´çº§' };
                const lesson = { id: 'unit1-lesson1', name: 'Unit 1 Hello' };
                
                // å¯¼èˆªåˆ°å­¦ç§‘é€‰æ‹©
                controller.navigateTo(PageType.SUBJECT);
                expect(controller.getCurrentState().currentPage).toBe(PageType.SUBJECT);
                
                // é€‰æ‹©å­¦ç§‘åå¯¼èˆªåˆ°æ•™æé€‰æ‹©
                controller.navigateTo(PageType.TEXTBOOK, { subject });
                expect(controller.getCurrentState().currentPage).toBe(PageType.TEXTBOOK);
                expect(controller.getCurrentState().selectedSubject).toEqual(subject);
                
                // é€‰æ‹©æ•™æåå¯¼èˆªåˆ°ç« èŠ‚å¯¼èˆª
                controller.navigateTo(PageType.CHAPTER, { textbook });
                expect(controller.getCurrentState().currentPage).toBe(PageType.CHAPTER);
                expect(controller.getCurrentState().selectedTextbook).toEqual(textbook);
                
                // é€‰æ‹©è¯¾ç¨‹åå¯¼èˆªåˆ°é˜…è¯»é¡µé¢
                controller.navigateTo(PageType.READING, { lesson, pageNumber: 1 });
                expect(controller.getCurrentState().currentPage).toBe(PageType.READING);
                expect(controller.getCurrentState().selectedLesson).toEqual(lesson);
                expect(controller.getCurrentState().currentPageNumber).toBe(1);
            });

            test('AppController åº”è¯¥æ”¯æŒè¿”å›å¯¼èˆª', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                // å¯¼èˆªåˆ°é˜…è¯»é¡µé¢
                controller.navigateTo(PageType.READING);
                expect(controller.getCurrentState().currentPage).toBe(PageType.READING);
                
                // è¿”å›åˆ°ç« èŠ‚é¡µé¢
                controller.goBack();
                expect(controller.getCurrentState().currentPage).toBe(PageType.CHAPTER);
                
                // è¿”å›åˆ°æ•™æé¡µé¢
                controller.goBack();
                expect(controller.getCurrentState().currentPage).toBe(PageType.TEXTBOOK);
                
                // è¿”å›åˆ°å­¦ç§‘é¡µé¢
                controller.goBack();
                expect(controller.getCurrentState().currentPage).toBe(PageType.SUBJECT);
                
                // è¿”å›åˆ°é¦–é¡µ
                controller.goBack();
                expect(controller.getCurrentState().currentPage).toBe(PageType.HOME);
            });

            test('AppController çŠ¶æ€åº”è¯¥åœ¨ç»„ä»¶é—´æ­£ç¡®ä¼ é€’', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const subject = { id: 'english', name: 'è‹±è¯­' };
                const textbook = { id: 'pep-grade3', name: 'äººæ•™ç‰ˆä¸‰å¹´çº§' };
                const lesson = { id: 'unit1-lesson1', name: 'Unit 1 Hello', totalPages: 5 };
                const voice = { id: 'voice-female', name: 'å¥³å£°' };
                
                // è®¾ç½®å®Œæ•´çŠ¶æ€
                controller.navigateTo(PageType.READING, {
                    subject,
                    textbook,
                    lesson,
                    pageNumber: 3
                });
                controller.setSelectedVoice(voice);
                controller.setPlaying(true);
                
                // éªŒè¯çŠ¶æ€
                const state = controller.getCurrentState();
                expect(state.selectedSubject).toEqual(subject);
                expect(state.selectedTextbook).toEqual(textbook);
                expect(state.selectedLesson).toEqual(lesson);
                expect(state.currentPageNumber).toBe(3);
                expect(state.selectedVoice).toEqual(voice);
                expect(state.isPlaying).toBe(true);
            });
        });

        describe('ProgressTracker é›†æˆæµ‹è¯•', () => {
            test('ProgressTracker åº”è¯¥èƒ½è®¾ç½®æ•™æä¸Šä¸‹æ–‡', () => {
                const tracker = new ProgressTracker(storageManager, dataManager);
                tracker.setCurrentTextbook('test-textbook-id');
                expect(tracker.getCurrentTextbookId()).toBe('test-textbook-id');
            });

            test('ProgressTracker åº”è¯¥èƒ½è®°å½•é¡µé¢è®¿é—®', () => {
                const tracker = new ProgressTracker(storageManager, dataManager);
                tracker.setCurrentTextbook('test-textbook-id');
                
                const result = tracker.recordPageVisit('lesson-1', 1);
                expect(result).toBe(true);
                
                const visitedPages = tracker.getVisitedPages('lesson-1');
                expect(visitedPages).toContain(1);
            });

            test('ProgressTracker åº”è¯¥èƒ½æ£€æµ‹è¯¾ç¨‹å®Œæˆ', () => {
                const tracker = new ProgressTracker(storageManager, dataManager);
                tracker.setCurrentTextbook('test-textbook-complete');
                
                // è®°å½•è¯¾ç¨‹å®Œæˆ
                const result = tracker.recordLessonComplete('lesson-complete-test');
                expect(result).toBe(true);
                
                // éªŒè¯å®ŒæˆçŠ¶æ€
                const isCompleted = tracker.isLessonCompleted('lesson-complete-test');
                expect(isCompleted).toBe(true);
            });
        });

        describe('ç»„ä»¶ä¸ DataManager é›†æˆæµ‹è¯•', () => {
            test('SubjectSelector åº”è¯¥èƒ½ä½¿ç”¨ DataManager åŠ è½½æ•°æ®', async () => {
                const container = document.createElement('div');
                const selector = new SubjectSelector(container);
                selector.setDataManager(dataManager);
                
                const subjects = await selector.loadSubjects();
                expect(subjects).toBeTruthy();
                expect(Array.isArray(subjects)).toBe(true);
            });

            test('TextbookSelector åº”è¯¥èƒ½ä½¿ç”¨ DataManager åŠ è½½æ•°æ®', async () => {
                const container = document.createElement('div');
                const selector = new TextbookSelector(container);
                selector.setDataManager(dataManager);
                
                const textbooks = await selector.loadTextbooks('english');
                expect(textbooks).toBeTruthy();
                expect(Array.isArray(textbooks)).toBe(true);
            });

            test('ChapterNavigator åº”è¯¥èƒ½ä½¿ç”¨ DataManager åŠ è½½æ•°æ®', async () => {
                const container = document.createElement('div');
                const navigator = new ChapterNavigator(container);
                navigator.setDataManager(dataManager);
                
                const chapters = await navigator.loadChapters('pep-english-grade3-1');
                expect(chapters).toBeTruthy();
                expect(Array.isArray(chapters)).toBe(true);
            });
        });

        describe('Requirements éªŒè¯', () => {
            test('Requirement 1.3: å­¦ç§‘é€‰æ‹©ååº”è‡ªåŠ¨è·³è½¬åˆ°æ•™æé€‰æ‹©', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                let navigationTriggered = false;
                controller.on('navigation:change', (data) => {
                    if (data.to === PageType.TEXTBOOK) {
                        navigationTriggered = true;
                    }
                });
                
                // æ¨¡æ‹Ÿå­¦ç§‘é€‰æ‹©åçš„å¯¼èˆª
                controller.navigateTo(PageType.TEXTBOOK, { 
                    subject: { id: 'english', name: 'è‹±è¯­' } 
                });
                
                expect(navigationTriggered).toBe(true);
                expect(controller.getCurrentState().currentPage).toBe(PageType.TEXTBOOK);
            });

            test('Requirement 2.2: æ•™æé€‰æ‹©ååº”è®°å½•å¹¶åŠ è½½ç« èŠ‚', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const textbook = { id: 'pep-grade3', name: 'äººæ•™ç‰ˆä¸‰å¹´çº§' };
                
                controller.navigateTo(PageType.CHAPTER, { textbook });
                
                const state = controller.getCurrentState();
                expect(state.currentPage).toBe(PageType.CHAPTER);
                expect(state.selectedTextbook).toEqual(textbook);
            });

            test('Requirement 3.3: è¯¾ç¨‹é€‰æ‹©ååº”åŠ è½½ç¬¬ä¸€é¡µå†…å®¹', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const lesson = { id: 'unit1-lesson1', name: 'Unit 1 Hello', totalPages: 5 };
                
                controller.navigateTo(PageType.READING, { 
                    lesson, 
                    pageNumber: 1 
                });
                
                const state = controller.getCurrentState();
                expect(state.currentPage).toBe(PageType.READING);
                expect(state.selectedLesson).toEqual(lesson);
                expect(state.currentPageNumber).toBe(1);
            });
        });

        // ========================================
        // æ¸²æŸ“æµ‹è¯•ç»“æœ
        // ========================================
        function renderResults() {
            const container = document.getElementById('testResults');
            const summaryEl = document.getElementById('summary');
            
            // æŒ‰æµ‹è¯•å¥—ä»¶åˆ†ç»„
            const suites = {};
            testResults.forEach(result => {
                if (!suites[result.suite]) {
                    suites[result.suite] = [];
                }
                suites[result.suite].push(result);
            });

            // æ¸²æŸ“æ¯ä¸ªæµ‹è¯•å¥—ä»¶
            let html = '';
            for (const [suiteName, tests] of Object.entries(suites)) {
                html += `<div class="test-suite">
                    <h2>${suiteName}</h2>`;
                
                tests.forEach(test => {
                    const icon = test.pass ? 'âœ…' : 'âŒ';
                    const className = test.pass ? 'pass' : 'fail';
                    html += `<div class="test-case ${className}">
                        <span class="icon">${icon}</span>
                        <span>${test.name}</span>
                    </div>`;
                    if (!test.pass && test.error) {
                        html += `<div class="error-detail">${test.error}</div>`;
                    }
                });
                
                html += '</div>';
            }
            
            container.innerHTML = html;

            // æ¸²æŸ“æ‘˜è¦
            const passed = testResults.filter(r => r.pass).length;
            const failed = testResults.filter(r => !r.pass).length;
            const total = testResults.length;
            
            summaryEl.className = `summary ${failed === 0 ? 'all-pass' : 'has-fail'}`;
            summaryEl.innerHTML = `
                <strong>æµ‹è¯•ç»“æœ:</strong> ${passed}/${total} é€šè¿‡
                ${failed > 0 ? ` | ${failed} å¤±è´¥` : ' | å…¨éƒ¨é€šè¿‡ ğŸ‰'}
            `;
        }

        // è¿è¡Œæµ‹è¯•å¹¶æ¸²æŸ“ç»“æœ
        renderResults();
    </script>
</body>
</html>
