<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppController æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-suite {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-suite h2 {
            margin-top: 0;
            color: #555;
            font-size: 1.1em;
        }
        .test-case {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-case.pass {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .test-case.fail {
            background: #ffebee;
            color: #c62828;
        }
        .test-case .icon {
            font-size: 1.2em;
        }
        .summary {
            background: #333;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .summary.all-pass {
            background: #4CAF50;
        }
        .summary.has-fail {
            background: #f44336;
        }
        .error-detail {
            font-size: 0.85em;
            color: #c62828;
            margin-left: 30px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª AppController å•å…ƒæµ‹è¯•</h1>
    <div id="testResults"></div>
    <div id="summary" class="summary"></div>

    <script src="../js/controllers/AppController.js"></script>
    <script>
        // ç®€å•çš„æµ‹è¯•æ¡†æ¶
        const testResults = [];
        let currentSuite = '';

        function describe(name, fn) {
            currentSuite = name;
            fn();
        }

        function test(name, fn) {
            try {
                fn();
                testResults.push({ suite: currentSuite, name, pass: true });
            } catch (error) {
                testResults.push({ suite: currentSuite, name, pass: false, error: error.message });
            }
        }

        function expect(actual) {
            return {
                toBe(expected) {
                    if (actual !== expected) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toEqual(expected) {
                    if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                        throw new Error(`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeNull() {
                    if (actual !== null) {
                        throw new Error(`Expected null, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeTruthy() {
                    if (!actual) {
                        throw new Error(`Expected truthy value, got ${JSON.stringify(actual)}`);
                    }
                },
                toBeFalsy() {
                    if (actual) {
                        throw new Error(`Expected falsy value, got ${JSON.stringify(actual)}`);
                    }
                },
                toContain(item) {
                    if (!actual.includes(item)) {
                        throw new Error(`Expected array to contain ${JSON.stringify(item)}`);
                    }
                },
                toHaveProperty(prop) {
                    if (!(prop in actual)) {
                        throw new Error(`Expected object to have property "${prop}"`);
                    }
                },
                toHaveBeenCalled() {
                    if (!actual.called) {
                        throw new Error('Expected function to have been called');
                    }
                },
                toHaveBeenCalledTimes(times) {
                    if (actual.callCount !== times) {
                        throw new Error(`Expected ${times} calls, got ${actual.callCount}`);
                    }
                },
                toHaveBeenCalledWith(expected) {
                    const found = actual.calls.some(call => 
                        JSON.stringify(call) === JSON.stringify([expected])
                    );
                    if (!found) {
                        throw new Error(`Expected to be called with ${JSON.stringify(expected)}`);
                    }
                }
            };
        }

        // ç®€å•çš„ mock å‡½æ•°
        function createMock() {
            const mock = function(...args) {
                mock.called = true;
                mock.callCount++;
                mock.calls.push(args);
                mock.lastCall = args;
                if (mock.implementation) {
                    return mock.implementation(...args);
                }
            };
            mock.called = false;
            mock.callCount = 0;
            mock.calls = [];
            mock.lastCall = null;
            mock.mockImplementation = (fn) => {
                mock.implementation = fn;
                return mock;
            };
            return mock;
        }

        // ========================================
        // æµ‹è¯•ç”¨ä¾‹
        // ========================================

        describe('åˆå§‹åŒ–æµ‹è¯•', () => {
            test('åº”è¯¥æ­£ç¡®åˆå§‹åŒ–åº”ç”¨çŠ¶æ€', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                const state = controller.getCurrentState();

                expect(state.currentPage).toBe(PageType.HOME);
                expect(state.selectedSubject).toBeNull();
                expect(state.selectedTextbook).toBeNull();
                expect(state.selectedLesson).toBeNull();
                expect(state.currentPageNumber).toBe(1);
                expect(state.isPlaying).toBe(false);
                expect(state.isLoading).toBe(false);
            });

            test('åˆå§‹åŒ–æ—¶åº”è¯¥è§¦å‘ app:initialized äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                const callback = createMock();
                controller.on('app:initialized', callback);
                
                controller.init();

                expect(callback).toHaveBeenCalled();
            });
        });

        describe('é¡µé¢å¯¼èˆªæµ‹è¯• (navigateTo)', () => {
            test('åº”è¯¥æ­£ç¡®å¯¼èˆªåˆ°æŒ‡å®šé¡µé¢', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                controller.navigateTo(PageType.SUBJECT);
                
                const state = controller.getCurrentState();
                expect(state.currentPage).toBe(PageType.SUBJECT);
            });

            test('å¯¼èˆªæ—¶åº”è¯¥æ›´æ–°ç›¸å…³çŠ¶æ€å‚æ•°', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const subject = { id: 'english', name: 'è‹±è¯­' };
                controller.navigateTo(PageType.SUBJECT, { subject });

                const state = controller.getCurrentState();
                expect(state.currentPage).toBe(PageType.SUBJECT);
                expect(state.selectedSubject).toEqual(subject);
            });

            test('å¯¼èˆªæ—¶åº”è¯¥è§¦å‘ navigation:change äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('navigation:change', callback);

                controller.navigateTo(PageType.TEXTBOOK);

                expect(callback).toHaveBeenCalled();
            });

            test('åº”è¯¥æ”¯æŒæ‰€æœ‰æœ‰æ•ˆçš„é¡µé¢ç±»å‹', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const validPages = [
                    PageType.HOME,
                    PageType.SUBJECT,
                    PageType.TEXTBOOK,
                    PageType.CHAPTER,
                    PageType.READING,
                    PageType.SETTINGS
                ];

                validPages.forEach(page => {
                    controller.navigateTo(page);
                    expect(controller.getCurrentState().currentPage).toBe(page);
                });
            });

            test('å¯¼èˆªå‚æ•°åº”è¯¥æ­£ç¡®ä¼ é€’', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const params = {
                    subject: { id: 'english' },
                    textbook: { id: 'pep-grade3' },
                    lesson: { id: 'unit1-lesson1' },
                    pageNumber: 5
                };

                controller.navigateTo(PageType.READING, params);

                const state = controller.getCurrentState();
                expect(state.selectedSubject).toEqual(params.subject);
                expect(state.selectedTextbook).toEqual(params.textbook);
                expect(state.selectedLesson).toEqual(params.lesson);
                expect(state.currentPageNumber).toBe(5);
            });
        });

        describe('è¿”å›å¯¼èˆªæµ‹è¯• (goBack)', () => {
            test('ä»å­¦ç§‘é¡µé¢è¿”å›åº”è¯¥åˆ°é¦–é¡µ', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                controller.navigateTo(PageType.SUBJECT);
                const result = controller.goBack();

                expect(result).toBe(true);
                expect(controller.getCurrentState().currentPage).toBe(PageType.HOME);
            });

            test('ä»æ•™æé¡µé¢è¿”å›åº”è¯¥åˆ°å­¦ç§‘é¡µé¢', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                controller.navigateTo(PageType.TEXTBOOK);
                controller.goBack();

                expect(controller.getCurrentState().currentPage).toBe(PageType.SUBJECT);
            });

            test('ä»é¦–é¡µè¿”å›åº”è¯¥è¿”å› false', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const result = controller.goBack();

                expect(result).toBe(false);
                expect(controller.getCurrentState().currentPage).toBe(PageType.HOME);
            });
        });

        describe('çŠ¶æ€ç®¡ç†æµ‹è¯• (getCurrentState)', () => {
            test('åº”è¯¥è¿”å›çŠ¶æ€çš„å‰¯æœ¬è€Œéå¼•ç”¨', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const state1 = controller.getCurrentState();
                const state2 = controller.getCurrentState();

                // ä¿®æ”¹ state1 ä¸åº”å½±å“ state2
                state1.currentPage = 'modified';
                expect(state2.currentPage).toBe(PageType.HOME);
            });

            test('åº”è¯¥åŒ…å«æ‰€æœ‰å¿…è¦çš„çŠ¶æ€å­—æ®µ', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const state = controller.getCurrentState();

                expect(state).toHaveProperty('currentPage');
                expect(state).toHaveProperty('selectedSubject');
                expect(state).toHaveProperty('selectedTextbook');
                expect(state).toHaveProperty('selectedLesson');
                expect(state).toHaveProperty('currentPageNumber');
                expect(state).toHaveProperty('selectedVoice');
                expect(state).toHaveProperty('isPlaying');
                expect(state).toHaveProperty('isLoading');
            });
        });

        describe('äº‹ä»¶å‘å¸ƒ/è®¢é˜…æµ‹è¯• (on, emit)', () => {
            test('åº”è¯¥èƒ½å¤Ÿæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('test:event', callback);

                controller.emit('test:event', { data: 'test' });

                expect(callback).toHaveBeenCalled();
            });

            test('åº”è¯¥æ”¯æŒå¤šä¸ªç›‘å¬å™¨', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback1 = createMock();
                const callback2 = createMock();

                controller.on('multi:event', callback1);
                controller.on('multi:event', callback2);

                controller.emit('multi:event', 'data');

                expect(callback1).toHaveBeenCalled();
                expect(callback2).toHaveBeenCalled();
            });

            test('åº”è¯¥è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                const unsubscribe = controller.on('unsub:event', callback);

                controller.emit('unsub:event');
                expect(callback.callCount).toBe(1);

                unsubscribe();
                controller.emit('unsub:event');
                expect(callback.callCount).toBe(1); // ä»ç„¶æ˜¯1æ¬¡
            });

            test('off æ–¹æ³•åº”è¯¥ç§»é™¤ç›‘å¬å™¨', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('off:event', callback);

                controller.emit('off:event');
                expect(callback.callCount).toBe(1);

                controller.off('off:event', callback);
                controller.emit('off:event');
                expect(callback.callCount).toBe(1);
            });

            test('once æ–¹æ³•åº”è¯¥åªè§¦å‘ä¸€æ¬¡', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.once('once:event', callback);

                controller.emit('once:event', 'first');
                controller.emit('once:event', 'second');
                controller.emit('once:event', 'third');

                expect(callback.callCount).toBe(1);
            });

            test('getListenerCount åº”è¯¥è¿”å›æ­£ç¡®çš„ç›‘å¬å™¨æ•°é‡', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                expect(controller.getListenerCount('count:event')).toBe(0);

                controller.on('count:event', createMock());
                expect(controller.getListenerCount('count:event')).toBe(1);

                controller.on('count:event', createMock());
                expect(controller.getListenerCount('count:event')).toBe(2);
            });

            test('clearAllListeners åº”è¯¥æ¸…é™¤æ‰€æœ‰ç›‘å¬å™¨', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                controller.on('clear:event1', createMock());
                controller.on('clear:event2', createMock());

                controller.clearAllListeners();

                expect(controller.getRegisteredEvents().length).toBe(0);
            });
        });

        describe('çŠ¶æ€æ›´æ–°æ–¹æ³•æµ‹è¯•', () => {
            test('setLoading åº”è¯¥æ›´æ–°åŠ è½½çŠ¶æ€å¹¶è§¦å‘äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('loading:change', callback);

                controller.setLoading(true);
                expect(controller.getCurrentState().isLoading).toBe(true);
                expect(callback).toHaveBeenCalled();
            });

            test('setPlaying åº”è¯¥æ›´æ–°æ’­æ”¾çŠ¶æ€å¹¶è§¦å‘äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('playing:change', callback);

                controller.setPlaying(true);
                expect(controller.getCurrentState().isPlaying).toBe(true);
                expect(callback).toHaveBeenCalled();
            });

            test('setSelectedVoice åº”è¯¥æ›´æ–°éŸ³è‰²å¹¶è§¦å‘äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('voice:change', callback);

                const voice = { id: 'female', name: 'å¥³å£°' };
                controller.setSelectedVoice(voice);

                expect(controller.getCurrentState().selectedVoice).toEqual(voice);
                expect(callback).toHaveBeenCalled();
            });

            test('setCurrentPageNumber åº”è¯¥æ›´æ–°é¡µç å¹¶è§¦å‘äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('pageNumber:change', callback);

                controller.setCurrentPageNumber(5);

                expect(controller.getCurrentState().currentPageNumber).toBe(5);
                expect(callback).toHaveBeenCalled();
            });
        });

        describe('é‡ç½®åŠŸèƒ½æµ‹è¯•', () => {
            test('reset åº”è¯¥é‡ç½®æ‰€æœ‰çŠ¶æ€', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                // å…ˆä¿®æ”¹ä¸€äº›çŠ¶æ€
                controller.navigateTo(PageType.READING, {
                    subject: { id: 'english' },
                    textbook: { id: 'pep' },
                    lesson: { id: 'unit1' },
                    pageNumber: 10
                });
                controller.setPlaying(true);
                controller.setLoading(true);

                // é‡ç½®
                controller.reset();

                const state = controller.getCurrentState();
                expect(state.currentPage).toBe(PageType.HOME);
                expect(state.selectedSubject).toBeNull();
                expect(state.selectedTextbook).toBeNull();
                expect(state.selectedLesson).toBeNull();
                expect(state.currentPageNumber).toBe(1);
                expect(state.isPlaying).toBe(false);
                expect(state.isLoading).toBe(false);
            });

            test('reset åº”è¯¥è§¦å‘ app:reset äº‹ä»¶', () => {
                const controller = new AppController();
                controller.setDebug(false);
                controller.init();
                
                const callback = createMock();
                controller.on('app:reset', callback);

                controller.reset();

                expect(callback).toHaveBeenCalled();
            });
        });

        describe('PageType æšä¸¾æµ‹è¯•', () => {
            test('åº”è¯¥åŒ…å«æ‰€æœ‰å¿…è¦çš„é¡µé¢ç±»å‹', () => {
                expect(PageType.HOME).toBe('home');
                expect(PageType.SUBJECT).toBe('subject');
                expect(PageType.TEXTBOOK).toBe('textbook');
                expect(PageType.CHAPTER).toBe('chapter');
                expect(PageType.READING).toBe('reading');
                expect(PageType.SETTINGS).toBe('settings');
            });

            test('PageType åº”è¯¥æ˜¯ä¸å¯å˜çš„', () => {
                expect(Object.isFrozen(PageType)).toBe(true);
            });
        });

        // ========================================
        // æ¸²æŸ“æµ‹è¯•ç»“æœ
        // ========================================
        function renderResults() {
            const container = document.getElementById('testResults');
            const summaryEl = document.getElementById('summary');
            
            // æŒ‰æµ‹è¯•å¥—ä»¶åˆ†ç»„
            const suites = {};
            testResults.forEach(result => {
                if (!suites[result.suite]) {
                    suites[result.suite] = [];
                }
                suites[result.suite].push(result);
            });

            // æ¸²æŸ“æ¯ä¸ªæµ‹è¯•å¥—ä»¶
            let html = '';
            for (const [suiteName, tests] of Object.entries(suites)) {
                html += `<div class="test-suite">
                    <h2>${suiteName}</h2>`;
                
                tests.forEach(test => {
                    const icon = test.pass ? 'âœ…' : 'âŒ';
                    const className = test.pass ? 'pass' : 'fail';
                    html += `<div class="test-case ${className}">
                        <span class="icon">${icon}</span>
                        <span>${test.name}</span>
                    </div>`;
                    if (!test.pass && test.error) {
                        html += `<div class="error-detail">${test.error}</div>`;
                    }
                });
                
                html += '</div>';
            }
            
            container.innerHTML = html;

            // æ¸²æŸ“æ‘˜è¦
            const passed = testResults.filter(r => r.pass).length;
            const failed = testResults.filter(r => !r.pass).length;
            const total = testResults.length;
            
            summaryEl.className = `summary ${failed === 0 ? 'all-pass' : 'has-fail'}`;
            summaryEl.innerHTML = `
                <strong>æµ‹è¯•ç»“æœ:</strong> ${passed}/${total} é€šè¿‡
                ${failed > 0 ? ` | ${failed} å¤±è´¥` : ' | å…¨éƒ¨é€šè¿‡ ğŸ‰'}
            `;
        }

        // è¿è¡Œæµ‹è¯•å¹¶æ¸²æŸ“ç»“æœ
        renderResults();
    </script>
</body>
</html>
